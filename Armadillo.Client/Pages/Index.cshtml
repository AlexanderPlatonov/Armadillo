@page "/"
@inject HttpClient Http

@using Armadillo.Chart
@using Armadillo.Shared
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.Timers
@using Microsoft.AspNetCore.WebUtilities

<select bind="@ProductName">
    @foreach (var item in ProductNames)
    {
        <option value="@item">@item</option>        
    }
</select>
<span>&nbsp;&nbsp;</span>

<input type="checkbox" bind="@ShowCustomers" id="show-customers"/>
<label for="show-customers">Show customers</label>

<span>&nbsp;&nbsp;</span>
<input type="checkbox" bind="@ShowOwners" id="show-owners"/>
<label for="show-owners">Show owners</label>

<span>&nbsp;&nbsp;</span>
<input type="checkbox" bind="@Autorefresh" id="autorefresh"/>
<label for="autorefresh">Auto refresh every @(timer_.Interval/60000) min.</label>

@if (ProductSubcases == null)
{
    <h1>Loading...</h1>
}
else
{
    <h1>@ProductSubcases.Subcases.Length subcases</h1>
    <SubcaseGraph Product=@ProductSubcases ShowCustomers=@ShowCustomers ShowOwners=@ShowOwners/>
}

@functions {
    private Timer timer_ = new Timer(1000 * 60 * 30);
    private IEnumerable<string> ProductNames { get; set; } = new string[]{};
    
    private string productName_;
    private string ProductName
    { 
        get
        {  
             return productName_;
        }
        set
        {
            productName_ = value;
            ReloadSubcases();
        }
    }

    private bool autorefresh_ = true;
    private bool Autorefresh
    { 
        get
        {  
             return autorefresh_;
        }
        set
        {
            autorefresh_ = value;
            timer_.Enabled = autorefresh_;
        }
    }

    private bool ShowCustomers { get; set; } = true;
    private bool ShowOwners { get; set; } = true;
    private Product ProductSubcases { get; set; }

    protected override async Task OnInitAsync()
    {
        ProductNames = await Http.GetJsonAsync<IEnumerable<string>>("api/products");
        ProductName = ProductNames.FirstOrDefault();
        
        timer_.Elapsed += (sender, e) => ReloadSubcases();
        timer_.Enabled = Autorefresh;
    }

    private void ReloadSubcases()
    {
        ProductSubcases = null;
        Task.Run(async () => {
            var url = QueryHelpers.AddQueryString("api/subcases", "product", ProductName);
            ProductSubcases = await Http.GetJsonAsync<Product>(url);
            StateHasChanged();
        });
    }
}
